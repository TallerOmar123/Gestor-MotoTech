<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor MotoTech 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>




    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f4f7f6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #007bff;
            text-align: center;
            font-weight: bold;
        }

        .form-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn-whatsapp {
            text-decoration: none;
            color: white !important;
            background-color: #dc3545;
            /* Rojo de alerta */
            padding: 6px 12px;
            border-radius: 6px;
            display: inline-block;
            font-size: 0.85em;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .btn-whatsapp:hover {
            background-color: #a71d2a;
            /* Rojo m√°s oscuro al pasar el mouse */
        }

        .table-alerta {
            border-left: 6px solid #dc3545;
        }

        .sticky-search {
            position: sticky;
            top: 10px;
            z-index: 1000;
            margin-bottom: 25px;
        }

        .card-header-edit {
            background-color: #0d6efd;
            color: white;
        }






        /* --- NUEVO: OPTIMIZACI√ìN M√ìVIL Y FORMULARIO PROFESIONAL --- */
        @media (max-width: 768px) {
            .form-group {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* Todo en una columna en m√≥vil */
            .btn-gestion-movil {
                width: 100%;
                margin-bottom: 5px;
                padding: 10px;
                font-size: 1rem;
            }

            .container {
                padding: 10px;
                border-radius: 0;
            }
        }

        .check-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .check-item:hover {
            background: #e9ecef;
        }

        .seccion-titulo {
            border-bottom: 2px solid #007bff;
            color: #007bff;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 15px;
        }
    </style>
</head>





<body>
    <div class="container">

        <div class="text-center mb-4">
            <img src="{{ url_for('static', filename='logo.jpg') }}" alt="Logo MotoTech"
                style="width: 350px; height: auto; border-radius: 10px;">
            <h1 class="mt-2">üèçÔ∏è Gestor MotoTech</h1>
        </div>
        <div class="row mb-4 justify-content-center">
            <div class="col-md-10">
                <div class="card shadow-lg border-0 text-white"
                    style="background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); border-radius: 15px;">
                    <div class="card-body p-4">
                        <div class="row align-items-center text-center">
                            <div class="col-12">
                                <p class="text-uppercase mb-1"
                                    style="letter-spacing: 3px; opacity: 0.7; font-size: 0.75rem;">üí∞ Balance Total de
                                    Ingresos</p>
                                <h2 class="display-4 fw-bold mb-0"
                                    style="color: #00d2ff; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                                    $ {{ "{:,.0f}".format(ingresos_totales) }}
                                </h2>
                                <div class="mt-2">
                                    <span class="badge rounded-pill bg-success" style="font-size: 0.8rem;">
                                        <i class="bi bi-graph-up"></i> Sistema Sincronizado
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>





        <div class="sticky-search">
            <input type="text" id="buscadorPlaca" placeholder="üîç BUSCAR CLIENTE O PLACA..."
                class="form-control form-control-lg border-danger shadow-sm">
        </div>







        <div class="card mb-5 shadow-sm">
            <div class="card-header {{ 'card-header-edit' if cliente_a_editar else 'bg-dark text-white' }}">
                <h4 class="mb-0 text-center">{{ '‚úèÔ∏è EDITAR DATOS' if cliente_a_editar else '‚ûï REGISTRAR MOTO' }}</h4>
            </div>
            <div class="card-body">
                <form action="{{ url_for('agregar_cliente_web') }}" method="POST" enctype="multipart/form-data">
                    <div class="seccion-titulo fw-bold mb-3"><i class="bi bi-person-vcard"></i> 1. Identificaci√≥n del
                        Veh√≠culo y Cliente</div>
                    <div class="form-group">
                        <div>
                            <label class="fw-bold small text-secondary">Placa:</label>
                            <input type="text" class="form-control border-primary fw-bold text-uppercase shadow-sm"
                                name="placa" required value="{{ placa_a_editar if placa_a_editar else '' }}"
                                {{ 'readonly' if placa_a_editar else '' }} placeholder="ABC-123">
                        </div>
                        <div>
                            <label class="fw-bold small text-secondary">Nombre del Propietario:</label>
                            <input type="text" class="form-control shadow-sm" name="due√±o" required
                                value="{{ cliente_a_editar.get('due√±o', '') if cliente_a_editar else '' }}"
                                placeholder="Ej: Juan P√©rez">
                        </div>
                        <div>
                            <label class="fw-bold small text-secondary">Tel√©fono WhatsApp:</label>
                            <input type="text" class="form-control shadow-sm" name="telefono"
                                value="{{ cliente_a_editar.get('telefono', '') if cliente_a_editar else '' }}"
                                placeholder="3001234567">
                        </div>
                        <div>
                            <label class="fw-bold small text-secondary">Kilometraje Actual:</label>
                            <input type="number" class="form-control border-warning shadow-sm" name="km_actual" required
                                value="{{ cliente_a_editar.get('km_actual', '') if cliente_a_editar else '' }}"
                                placeholder="00000">
                        </div>
                    </div>

                    <div class="seccion-titulo fw-bold mb-3 mt-4"><i class="bi bi-clipboard-check"></i> 2. Inventario de
                        Recepci√≥n</div>
                    <div class="row g-2 bg-light p-3 rounded border">
                        <div class="col-6 col-md-3">
                            <div class="check-item">
                                <input type="checkbox" name="inv_espejos" class="form-check-input" {{ 'checked' if
                                    cliente_a_editar and cliente_a_editar.get('inventario', {}).get('espejos')=='S√ç'
                                    else '' }}>
                                <small>Espejos</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="check-item">
                                <input type="checkbox" name="inv_direccionales" class="form-check-input" {{ 'checked' if
                                    cliente_a_editar and cliente_a_editar.get('inventario',
                                    {}).get('direccionales')=='S√ç' else '' }}>
                                <small>Luces/Dir.</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="check-item">
                                <input type="checkbox" name="inv_maletero" class="form-check-input" {{ 'checked' if
                                    cliente_a_editar and cliente_a_editar.get('inventario', {}).get('maletero')=='S√ç'
                                    else '' }}>
                                <small>Maletero</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <select class="form-select form-select-sm border-info" name="inv_gasolina">
                                {% set gas = cliente_a_editar.get('gasolina', '') if cliente_a_editar else '' %}
                                <option value="1/4" {{ 'selected' if gas=='1/4' else '' }}>‚õΩ Nivel: 1/4</option>
                                <option value="1/2" {{ 'selected' if gas=='1/2' else '' }}>‚õΩ Nivel: 1/2</option>
                                <option value="3/4" {{ 'selected' if gas=='3/4' else '' }}>‚õΩ Nivel: 3/4</option>
                                <option value="Full" {{ 'selected' if gas=='Full' else '' }}>‚õΩ Nivel: FULL</option>
                            </select>
                        </div>
                        <div class="seccion-titulo fw-bold mb-3 mt-4"><i class="bi bi-tools"></i> 3. Servicio y
                            Observaciones</div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="fw-bold small">Tipo de Intervenci√≥n:</label>
                                <select class="form-select fw-bold text-primary border-primary" name="tipo_servicio">
                                    <option value="Mantenimiento General">üõ†Ô∏è Mantenimiento General</option>
                                    <option value="Mantenimiento Preventivo">üîç Mantenimiento Preventivo</option>
                                    <option value="Reparaci√≥n T√©cnica">‚öôÔ∏è Reparaci√≥n T√©cnica</option>
                                    <option value="Garant√≠a">üéóÔ∏è Garant√≠a</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="fw-bold small">Referencia de Moto:</label>
                                <input type="text" class="form-control" name="moto" placeholder="Ej: Yamaha NMAX 155"
                                    value="{{ cliente_a_editar.get('moto', '') if cliente_a_editar else '' }}">
                            </div>
                            <div class="col-12">
                                <label class="fw-bold small text-danger">Observaciones de Ingreso (Rayones o
                                    fallas):</label>
                                <textarea class="form-control shadow-sm" name="notas_ingreso" rows="2"
                                    placeholder="Describa el estado visual...">{{ cliente_a_editar.get('notas_ingreso', '') if cliente_a_editar else '' }}</textarea>
                            </div>
                        </div>
                        <div class="seccion-titulo fw-bold mb-3 mt-4"><i class="bi bi-currency-dollar"></i> 4.
                            Liquidaci√≥n de Repuestos</div>
                        <div class="row g-3 bg-light p-3 rounded border">
                            <div class="col-12">
                                <label class="fw-bold small text-primary">Detalle de Repuestos (Lista manual):</label>
                                <textarea class="form-control shadow-sm" name="detalle_repuestos" rows="2"
                                    placeholder="Ej: Kit de arrastre - $120.000"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="fw-bold small">Total Repuestos ($):</label>
                                <input type="number" class="form-control border-success fw-bold"
                                    name="valor_total_repuestos" placeholder="Suma total">
                            </div>
                            <div class="col-md-6">
                                <label class="fw-bold small">üì∏ Foto Soporte:</label>
                                <input type="file" class="form-control form-control-sm" name="foto_factura"
                                    accept="image/*" capture="camera">
                            </div>
                        </div>
                        <div class="mt-4 d-flex gap-2">
                            <button type="submit" class="btn btn-primary w-100 fw-bold">üíæ GUARDAR</button>
                            {% if placa_a_editar %}<a href="/" class="btn btn-secondary px-4">CANCELAR</a>{% endif %}
                        </div>
                </form>
            </div>
        </div>





        <h3 class="text-danger fw-bold mb-3">üö® Mantenimientos Urgentes</h3>
        <div class="table-responsive mb-5 shadow-sm rounded">
            <table class="table table-bordered table-alerta align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Placa</th>
                        <th>Cliente</th>
                        <th>Faltan (km)</th>
                        <th>Estado</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    {% for moto in proximos %}
                    <tr class="{{ moto.get('clase_alerta', '') }}">
                        <td class="fw-bold">{{ moto.get('placa') }}</td>
                        <td>{{ moto.get('due√±o') }}</td>
                        <td>{{ (moto.get('km_proximo_mantenimiento', 0)|int) - (moto.get('km_actual', 0)|int) }} km</td>
                        <td class="fw-bold">{{ moto.get('estado') }}</td>
                        <td>
                            {% set diferencia_km = (moto.get('km_actual', 0)|int) -
                            (moto.get('km_proximo_mantenimiento', 0)|int) %}
                            <a href="https://wa.me/57{{ moto.get('telefono') }}?text={{ 'Hola ' + moto.get('due√±o') + ', te hablamos de MotoTech. üö® ALERTA DE SERVICIO: Tu moto (' + moto.get('placa') + ') ya se pas√≥ ' + diferencia_km|string + ' km del mantenimiento programado. Evita da√±os costosos y vis√≠tanos pronto. üõ†Ô∏è' | urlencode }}"
                                target="_blank" class="btn-whatsapp">
                                <i class="bi bi-whatsapp"></i> Notificar Alerta
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>





        <h3 class="fw-bold mb-3">üìã Clientes Registrados</h3>
        <div class="table-responsive shadow-sm rounded">
            <table class="table table-hover align-middle bg-white mb-0" id="tablaMotos">
                <thead class="table-secondary text-dark">
                    <tr>
                        <th>Placa</th>
                        <th>Due√±o</th>
                        <th>Moto</th>
                        <th>KM</th>
                        <th>Ingreso</th>
                        <th class="text-center">GESTI√ìN</th>
                    </tr>
                </thead>
                <tbody>
                    {% for moto in todos %}
                    <tr>
                        <td class="fw-bold text-primary">{{ moto.get('placa') }}</td>
                        <td>{{ moto.get('due√±o') }}</td>
                        <td><small>{{ moto.get('moto') }}</small></td>
                        <td>{{ moto.get('km_actual') }}</td>
                        <td class="text-center">
                            <a href="{{ url_for('generar_pdf', placa=moto.get('placa')) }}"
                                class="btn btn-sm btn-danger shadow-sm"
                                style="font-weight: bold; border: 1px solid #7c0000;">
                                <i class="bi bi-file-earmark-pdf"></i> üìÑ PDF
                            </a>
                            <a href="{{ url_for('enviar_whatsapp', placa=moto.get('placa')) }}" target="_blank"
                                class="btn btn-sm fw-bold ms-1 text-white"
                                style="background-color: #0056b3; border: 1px solid #004494; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                <i class="bi bi-clipboard-check-fill"></i> üí¨ Reporte T√©cnico
                            </a>
                            <a href="tel:{{ moto.get('telefono') }}"
                                class="btn btn-sm btn-info text-white fw-bold ms-1">
                                üìû Llamar
                            </a>
                            <button onclick="abrirServicio('{{ moto.get('placa') }}')"
                                class="btn btn-sm btn-warning fw-bold ms-1">üõ†Ô∏è</button>
                            <button onclick="verHistorial('{{ moto.get('placa') }}')" class="btn btn-sm ms-1 text-white"
                                style="background-color: #0056b3; border: 1px solid #004494; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                <i class="bi bi-eye-fill"></i>
                            </button>
                            <a href="/editar/{{ moto.get('placa') }}" class="btn btn-sm btn-outline-primary ms-1">‚úèÔ∏è</a>
                            <a href="/eliminar/{{ moto.get('placa') }}" class="btn btn-sm btn-outline-danger ms-1"
                                onclick="return confirmarEliminacion(event)">üóëÔ∏è</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>




        <div class="modal fade" id="mantenimientoModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="{{ url_for('agregar_mantenimiento_web') }}" method="POST"
                        enctype="multipart/form-data">
                        <div class="modal-header bg-warning">
                            <h5 class="modal-title fw-bold">üõ†Ô∏è Nuevo Trabajo</h5><button type="button"
                                class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="modal_placa" name="placa_mantenimiento"
                                class="form-control mb-2 text-center fw-bold" readonly>
                            <input type="number" name="km_mantenimiento" class="form-control mb-2"
                                placeholder="KM de entrada" required>
                            <textarea name="descripcion_mantenimiento" class="form-control mb-2"
                                placeholder="¬øQu√© se le hizo?" required></textarea>
                            <input type="number" name="costo_mantenimiento" class="form-control" placeholder="Costo $"
                                required>
                            <div class="mt-3 p-3 border rounded bg-light">
                                <h6 class="text-center fw-bold text-primary mb-3"
                                    style="border-bottom: 2px solid #0d6efd;">üìã HOJA DE RUTA T√âCNICA</h6>

                                <div class="mb-3">
                                    <span class="badge bg-dark mb-2">üõë SISTEMA DE FRENOS</span>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="small fw-bold">Freno Delantero:</label>
                                            <select name="freno_del" class="form-select form-select-sm">
                                                <option value="‚úÖ √ìptimo">‚úÖ √ìptimo</option>
                                                <option value="‚ö†Ô∏è Pronto Cambio">‚ö†Ô∏è Pronto Cambio</option>
                                                <option value="üö® Urgente">üö® Urgente</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <label class="small fw-bold">Freno Trasero:</label>
                                            <select name="freno_tras" class="form-select form-select-sm">
                                                <option value="‚úÖ √ìptimo">‚úÖ √ìptimo</option>
                                                <option value="‚ö†Ô∏è Pronto Cambio">‚ö†Ô∏è Pronto Cambio</option>
                                                <option value="üö® Urgente">üö® Urgente</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <label class="small fw-bold">L√≠quido Frenos/Caliper:</label>
                                            <select name="liq_frenos" class="form-select form-select-sm">
                                                <option value="‚úÖ √ìptimo">‚úÖ √ìptimo</option>
                                                <option value="‚ö†Ô∏è Pronto Cambio">‚ö†Ô∏è Pronto Cambio</option>
                                                <option value="üö® Urgente">üö® Urgente</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <span class="badge bg-dark mb-2">‚öôÔ∏è MOTOR Y SINCRONIZACI√ìN</span>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="small fw-bold">Lavado Carburador:</label>
                                            <select name="lavado_carburador" class="form-select form-select-sm">
                                                <option value="‚úÖ √ìptimo">‚úÖ √ìptimo</option>
                                                <option value="‚ö†Ô∏è Pronto Cambio">‚ö†Ô∏è Pronto Cambio</option>
                                                <option value="üö® Urgente">üö® Urgente</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <label class="small fw-bold">Filtro Aire / Buj√≠a:</label>
                                            <select name="filtro_bujia" class="form-select form-select-sm">
                                                <option value="‚úÖ √ìptimo">‚úÖ √ìptimo</option>
                                                <option value="‚ö†Ô∏è Pronto Cambio">‚ö†Ô∏è Pronto Cambio</option>
                                                <option value="üö® Urgente">üö® Urgente</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <span class="badge bg-dark mb-2">üèóÔ∏è CHASIS, TIJERA Y GUAYAS</span>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="small fw-bold">Engrase Tijera:</label>
                                            <select name="engrase_tijera" class="form-select form-select-sm">
                                                <option value="‚úÖ √ìptimo">‚úÖ √ìptimo</option>
                                                <option value="‚ö†Ô∏è Pronto Cambio">‚ö†Ô∏è Pronto Cambio</option>
                                                <option value="üö® Urgente">üö® Urgente</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <label class="small fw-bold">Mantenimiento Guayas:</label>
                                            <select name="mantenimiento_guayas" class="form-select form-select-sm">
                                                <option value="‚úÖ √ìptimo">‚úÖ √ìptimo</option>
                                                <option value="‚ö†Ô∏è Pronto Cambio">‚ö†Ô∏è Pronto Cambio</option>
                                                <option value="üö® Urgente">üö® Urgente</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="fecha_mantenimiento" value="{{ today }}">
                            <div class="mt-3 p-3 border rounded bg-white shadow-sm">
                                <label class="small fw-bold text-dark d-block mb-2">üì∏ REGISTRO FOTOGR√ÅFICO:</label>
                                <input type="file" name="fotos" accept="image/*" multiple
                                    class="form-control form-control-sm" id="inputFotos">
                                <div id="preview" class="d-flex gap-2 mt-2 overflow-x-auto"></div>
                            </div>

                            <script>
                                // Vista previa r√°pida para ver qu√© fotos est√°s subiendo
                                document.getElementById('inputFotos').addEventListener('change', function (e) {
                                    const preview = document.getElementById('preview');
                                    preview.innerHTML = '';
                                    Array.from(this.files).forEach(file => {
                                        const reader = new FileReader();
                                        reader.onload = function (ex) {
                                            const img = document.createElement('img');
                                            img.src = ex.target.result;
                                            img.style.width = '60px';
                                            img.style.height = '60px';
                                            img.className = 'rounded border object-fit-cover';
                                            preview.appendChild(img);
                                        }
                                        reader.readAsDataURL(file);
                                    });
                                });
                            </script>
                        </div>
                        <div class="modal-footer"><button type="submit" class="btn btn-warning fw-bold">GUARDAR</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>





        <div class="modal fade" id="historialModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header text-white"
                        style="background-color: #0056b3; border-bottom: 3px solid #004494;">
                        <h5 class="modal-title fw-bold">
                            <i class="bi bi-clipboard-check-fill"></i> Historial T√©cnico: <span
                                id="titulo_placa"></span>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Kilometraje</th>
                                        <th>Descripci√≥n</th>
                                        <th>Costo</th>
                                        <th class="text-center">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla_historial_cuerpo">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>





        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            // --- 1. FUNCI√ìN PARA REGISTRAR NUEVO SERVICIO ---
            // Abre el modal para escribir qu√© se le hizo a la moto.
            function abrirServicio(placa) {
                document.getElementById('modal_placa').value = placa;
                new bootstrap.Modal(document.getElementById('mantenimientoModal')).show();
            }


            // --- 2. L√ìGICA DEL BUSCADOR EN TIEMPO REAL ---
            // Filtra la tabla de clientes mientras vas escribiendo la placa.
            document.getElementById('buscadorPlaca').addEventListener('keyup', function (e) {
                const texto = e.target.value.toLowerCase();
                const filas = document.querySelectorAll('#tablaMotos tbody tr');
                filas.forEach(f => f.style.display = f.textContent.toLowerCase().includes(texto) ? '' : 'none');
            });


            // --- 3. FUNCI√ìN DE SEGURIDAD PARA ELIMINAR CLIENTE (VERSION ICONOS) ---
            function confirmarEliminacion(e) {
                e.preventDefault();
                const urlEliminar = e.currentTarget.getAttribute('href');

                Swal.fire({
                    title: '<i class="fa-solid fa-triangle-exclamation fa-beat" style="color: #dc3545;"></i><br>¬øELIMINAR CLIENTE?',
                    html: "Se borrar√° la moto y <b>todo su historial</b>.<br><span class='text-danger'>Esta acci√≥n no se puede deshacer.</span>",
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fa-solid fa-trash"></i> S√ç, ELIMINAR',
                    cancelButtonText: 'CANCELAR',
                    background: '#fff'
                }).then((result) => {
                    if (result.isConfirmed) { window.location.href = urlEliminar; }
                })
            }


            // --- 4. FUNCI√ìN VER HISTORIAL (LA QUE ESTABA VAC√çA) ---
            // Busca los mantenimientos de la moto y los muestra en la tabla azul.
            function verHistorial(placa) {
                // A. Identificar el t√≠tulo y la tabla dentro del modal
                const titulo = document.getElementById('titulo_placa');
                const cuerpoTabla = document.getElementById('tabla_historial_cuerpo');

                // B. Obtener la lista completa de clientes que envi√≥ Flask
                const todosLosClientes = {{ todos | tojson | safe
            }};

            // C. Buscar al cliente que coincida con la placa
            const clienteEncontrado = todosLosClientes.find(c => c.placa === placa);

            if (titulo) titulo.innerText = placa;
            if (!cuerpoTabla) return;

            cuerpoTabla.innerHTML = ""; // Limpiar datos de la consulta anterior

            if (clienteEncontrado) {
                // Intentamos sacar los datos de 'Mantenimientos' o de 'historial'
                const servicios = clienteEncontrado.Mantenimientos || clienteEncontrado.historial || [];

                if (servicios.length > 0) {
                    // Si hay servicios, creamos una fila por cada uno
                    servicios.forEach((s, index) => {
                        cuerpoTabla.innerHTML += `
                    <tr>
                        <td>${s.Fecha || 'S/F'}</td>
                        <td>${s.KM || 0} km</td>
                        <td>${s.Descripcion || 'Sin detalle'}</td>
                        <td class="text-success fw-bold">$${(s.Costo || 0).toLocaleString()}</td>
                        <td class="text-center">
                <button class="btn btn-sm btn-outline-danger shadow-sm" 
                    onclick="eliminarServicioIndividual('${placa}', ${index})">
                    üóëÔ∏è
                </button>
            </td>
                    </tr>`;
                    });
                } else {
                    cuerpoTabla.innerHTML = "<tr><td colspan='4' class='text-center text-muted'>No hay servicios registrados para esta placa.</td></tr>";
                }
            }

            // D. Mostrar visualmente el Modal de Historial
            const miModal = new bootstrap.Modal(document.getElementById('historialModal'));
            miModal.show();
    }
            // --- 3. FUNCI√ìN DE SEGURIDAD PARA ELIMINAR CLIENTE (VERSION ICONOS) ---
            function confirmarEliminacion(e) {
                e.preventDefault();
                const urlEliminar = e.currentTarget.getAttribute('href');

                Swal.fire({
                    title: '<i class="fa-solid fa-triangle-exclamation fa-beat" style="color: #dc3545;"></i><br>¬øELIMINAR CLIENTE?',
                    html: "Se borrar√° la moto y <b>todo su historial</b>.<br><span class='text-danger'>Esta acci√≥n no se puede deshacer.</span>",
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fa-solid fa-trash"></i> S√ç, ELIMINAR',
                    cancelButtonText: 'CANCELAR',
                    background: '#fff'
                }).then((result) => {
                    if (result.isConfirmed) { window.location.href = urlEliminar; }
                })
            }

            // --- 5. FUNCI√ìN PARA ELIMINAR SERVICIO INDIVIDUAL (VERSION ICONOS) ---
            function eliminarServicioIndividual(placa, index) {
                Swal.fire({
                    title: '<i class="fa-solid fa-eraser" style="color: #fd7e14;"></i><br>¬øQuitar registro?',
                    text: "Se borrar√° este mantenimiento de la placa " + placa,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#fd7e14',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fa-solid fa-check"></i> BORRAR',
                    cancelButtonText: 'VOLVER'
                }).then((result) => {
                    if (result.isConfirmed) {
                        localStorage.setItem('reabrir_historial_placa', placa);
                        localStorage.setItem('mostrar_exito_eliminacion', 'true');
                        window.location.href = `/eliminar_servicio/${placa}/${index}`;
                    }
                })
            }



            // --- 6. INYECCI√ìN FINAL: NOTIFICADOR FLOTANTE Y PERSISTENCIA ---
            window.addEventListener('load', function () {
                // Configuraci√≥n del mensaje flotante (Toast)
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    background: '#1a1a1a',
                    color: '#fff'
                });

                const placaParaReabrir = localStorage.getItem('reabrir_historial_placa');
                const mostrarExito = localStorage.getItem('mostrar_exito_eliminacion');

                // A. L√≥gica de reapertura autom√°tica
                if (placaParaReabrir) {
                    verHistorial(placaParaReabrir);
                    localStorage.removeItem('reabrir_historial_placa');

                    if (mostrarExito) {
                        Toast.fire({
                            icon: 'success',
                            title: '<i class="fa-solid fa-circle-check"></i> Registro eliminado'
                        });
                        localStorage.removeItem('mostrar_exito_eliminacion');
                    }
                }

                // B. Captura de mensajes de Flask (Guardado/Editado exitoso)
                {% with messages = get_flashed_messages(with_categories = true) %}
                {% if messages %}
                {% for category, message in messages %}
                Toast.fire({
                    icon: '{{ "success" if category == "success" else "info" }}',
                    title: '<i class="fa-solid fa-bell"></i> {{ message }}'
                });
                {% endfor %}
                {% endif %}
                {% endwith %}
            });
        </script>